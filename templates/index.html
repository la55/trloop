<!DOCTYPE html>
<html>
<head>
    <title>Bib Time</title>
    <script src="/static/vue.min.js"></script>
</head>
<body>
<style>
 table { width: 100%; } 
</style>
    <div id='root'>

            <div v-if="onAir == 1" style="background:green;padding:0.3em;color:white">
                Connected
            </div>
            <div v-if="onAir == 0" style="background:red;padding:0.3;color:white">
                No connection
            </div>
            <div>
              Show every:
              <select v-model="pulse">
                <option v-for="i in [1,2,4,8]" v-text="i">
                </option>
              </select>
              <label for="checkbox">Dist:</label>
              <input type="checkbox" id="dist" v-model="dist">
            </div>
            <table>
              <tr>
                <td> 
                  <table>
                      <tr>
                         <td>Bib:</td>
                         <td>P:</td>
                         <td v-if="dist == true">D:</td>
                         <td>Time</td>
                      </tr>
                      <tr v-for="time in times" v-if="time.pulse % pulse == 0">
                           <td v-text="time.bib"></td>
                           <td v-text="time.pulse"></td>
                           <td  v-if="dist == true" v-text="time.pulse * 125"></td>
                           <td v-text="time.res"></td>
                      </tr>
                  </table>
                </td> 
                <td> 
                   <div v-for="res in results">
                     <table>
                        <tr>
                           <th>â„–: <span v-text="res.bib"></span></th>
                        </tr>
                        <tr v-for="time in res.times" v-if="time.pulse % pulse == 0 && time.bib != 0">
                             <td v-text="time.pulse"></td>
                             <td  v-if="dist == true" v-text="time.pulse * 125"></td>
                             <td v-text="time.res"></td>
                             <td v-text="get_lap(time)"></td>
                        </tr>
                    </table>
                 </div>
                </td> 
              </tr>
            </table>
        </div>
    </div>
<script>
  var app = new Vue({
    
    el : '#root',

    data: {
        results: [],
        times : [],
        onAir : 0,
        pulse : 1,
        dist : true,
    },

    created: function () {
      this.ws =  new WebSocket("ws://127.0.0.1:8080/socket");
      this.ws.onopen = function(e) {
        app.onAir = 1
      }
      this.ws.onclose = function(e) {
        app.onAir = 0
      }
      this.ws.onmessage = function(e) {
        message = JSON.parse(e.data);
        if (message.action == 'result') {
          let res = message.result
          app.times.unshift(res)
          results = app.results.filter(time => time.key == res.key && time.bib == res.bib)
          if (results.length == 0) {
            app.results.push({ 'key': res.key, 'bib': res.bib, 'times': [res] })
          } else {
            results[0]['bib'] = res.bib
            results[0]['times'].push(res)
          }
        }
      }
    },

    methods: {
      get_lap : res => {
        let pulse = parseInt(res.pulse) - app.pulse
        let prev_res = 0 
        try {
          let prev_time = app.times.filter(time => time.key == res.key && time.pulse == pulse)[0]
          prev_res = app.time_to_int(prev_time.res)
        } catch {
        }
        return app.int_to_time(app.time_to_int(res.res) - prev_res)
      }, 
      time_to_int : time => {
        let mills = time.match(/\d\d\d/g)
        let seconds = time.match(/\d\d?,/g)
        let minutes = time.match(/\d\d?\:/g)
        if (mills != null) { mills = mills[0] } else { mills = 0}
        if (seconds != null) { seconds = seconds[0].replace(',', '') } else { seconds = 0}
        if (minutes != null) { minutes = minutes[0].replace(':', '') } else { minutes = 0}
        let time_int = parseInt(minutes) * 60000 + parseInt(seconds) * 1000 + parseInt(mills)
        return time_int
      }, 
      int_to_time : i_time => {
        let minutes = i_time / 60000 >> 0
        let sec_m = i_time % 60000
        let seconds = sec_m / 1000 >> 0
        let mills = sec_m % 1000
        time = 'none'
        if (minutes === 0) {
            time = `${seconds},${mills}`
        } else {
          if (seconds < 10) {
            time = `${minutes}:0${seconds},${mills}`
          } else {
            time = `${minutes}:${seconds},${mills}`
          }
        }
        return time
      }
    }

  });
</script>
</body>
</html>

